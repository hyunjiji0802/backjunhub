# '세단' 또는 'SUV' 인 자동차 중 2022년 11월 1일부터 2022년 11월 30일까지 대여 가능
# 30일간의 대여 금액이 50만원 이상 200만원 미만인 자동차
# 자동차 ID, 자동차 종류, 대여 금액


# SELECT * FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
# WHERE (START_DATE <'2022-11-01 00:00:00' AND END_DATE <'2022-11-01 00:00:00')
# OR (START_DATE >'2022-11-30 00:00:00' AND END_DATE >'2022-11-30 00:00:00')
# ORDER BY CAR_ID, START_DATE


WITH TMP AS (
SELECT 
    CAR_ID, CAR_TYPE, 30*DAILY_FEE AS TOTAL_FEE
FROM CAR_RENTAL_COMPANY_CAR c
WHERE CAR_TYPE IN ("SUV", "세단")
# 2022년 11월 1일부터 2022년 11월 30일 대여가능
AND NOT EXISTS (
  SELECT 1
  FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY h
  WHERE h.CAR_ID = c.CAR_ID
    AND NOT (h.END_DATE < '2022-11-01' OR h.START_DATE > '2022-11-30')
    )
)


SELECT 
    CAR_ID,
    CAR_TYPE,
     ROUND(TOTAL_FEE -TOTAL_FEE * DISCOUNT_RATE * 0.01, 0) AS FEE
FROM TMP
JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN 
USING (CAR_TYPE)
#30일 이상 대여 할인율
WHERE DURATION_TYPE = "30일 이상"
AND TOTAL_FEE - ROUND(TOTAL_FEE * DISCOUNT_RATE * 0.01, 0) >=500000
AND TOTAL_FEE - ROUND(TOTAL_FEE * DISCOUNT_RATE * 0.01, 0) <2000000
ORDER BY FEE DESC, CAR_TYPE, CAR_ID DESC


